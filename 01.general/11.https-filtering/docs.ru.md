---
title: 'Фильтрация HTTPS-соединений'
published: true
taxonomy:
    category:
        - docs
visible: true
---

### Что такое HTTPS?

HTTPS (аббр. от англ. HyperText Transfer Protocol Secure) — расширение протокола HTTP, для поддержки шифрования в целях повышения безопасности. Этот протокол используется для защищенной передачи важной информации - персональных данных, реквизитов банковских карт, и т.д.

Использование HTTPS - сугубо положительная вещь, ведь зашифрованный трафик защищен от “прослушивания” третьей стороной, и мы это только приветствуем. Рост HTTPS сильно ускорился в последние годы в связи с тем, что это [поощряется Google](https://webmasters.googleblog.com/2014/08/https-as-ranking-signal.html), а также с появлением бесплатного центра сертификации [Let’s Encrypt](https://ru.wikipedia.org/wiki/Let%27s_Encrypt).

На диаграмме ниже мы описали разницу между простым протоколом HTTP и защищенным протоколом HTTPS.

![Что такое HTTPS](https://cdn.adguard.com/public/Adguard/Blog/https/what_is_https_ru.png)

### Что такое сертификат безопасности?

Итак, HTTPS означает шифрование данных. Но остается еще одна проблема: как быть уверенным, что вы установили зашифрованную связь именно с тем сайтом, с которым планировали? Тут в игру и вступают сертификаты безопасности. Сертификат является удостоверением, что сайт представляет собой именно тот ресурс, за который себя и выдает. Если такого сертификата у сайта нет, или в нем содержится неправильная информация, то браузер не позволит вам установить защищенное соединение. При этом важно, чтобы сертификат, который использует сайт, был выдан центром сертификации, которому доверяет ваш браузер. Такие центры сертификации гарантируют, что сертификат выдан именно владельцу сайта.

### Зачем AdGuard нужно уметь фильтровать HTTPS?

Дело в том, что сейчас всё больше и больше сайтов, блогов и социальных сетей переходит на HTTPS. Кроме блогов и сайтов на HTTPS переходят всё больше рекламных сетей, так как это необходимо для отображения рекламы на сайте, работающем по HTTPS. Вот примеры популярных сайтов, рекламу на которых невозможно убрать без фильтрации HTTPS: youtube.com, facebook.com, twitter.com.

### Как происходит фильтрация зашифрованного трафика?

Если бы это было просто, HTTPS не был бы безопасным. При попытке браузера соединиться с сервером, AdGuard устанавливает два защищенных соединения. Одно - с браузером, второе - с сайтом. Важно, чтобы при этом браузер "доверял" AdGuard и созданному им соединению. Для этого AdGuard генерирует и устанавливает специальный корневой сертификат в систему и при необходимости - в некоторые браузеры (например, Firefox). Таким образом, AdGuard может увидеть, что происходит внутри защищенного соединения, и выполнить свою работу - заблокировать рекламу и трекинг.

Для лучшего понимания мы изобразили этот процесс на картинке:

![Как работает фильтрация HTTPS](https://cdn.adguard.com/public/Adguard/Blog/https/what_is_https_filtering_ru.png)

### Остается ли мой трафик защищенным и зашифрованным?

Конечно! Ваше соединение с удаленным сервером остается зашифрованным и защищенным. AdGuard, точно также как и браузер, проверяет сертификат сервера перед тем как принимает решение о фильтрации.

Тем не менее, фильтрация HTTPS имеет некоторые недостатки. Самым важным из них является то, что она скрывает от браузера свойства реального сертификата, используемого сайтом. Вместо этого браузер видит сертификат, сгенерированный AdGuard

В связи с этим, мы предпринимаем несколько дополнительных мер, призванных улучшить безопасность соединения, о которых речь пойдет ниже.

### Финансовые сайты, и сайты с важной персональной информацией

По умолчанию, AdGuard не фильтрует информацию для сайтов банков, платежных систем, а также сайтов с важной персональной информацией. Мы поддерживаем список из более чем [1300 таких сайтов-исключений](https://github.com/AdguardTeam/HttpsExclusions).

Если вы считаете, что какой-то сайт должен быть добавлен в этот список, пожалуйста, [напишите нам об этом](https://github.com/AdguardTeam/HttpsExclusions/issues/new).

### Сертификаты высокой надежности (EV)

AdGuard предоставляет возможность исключить из фильтрации все сайты, которые используют сертификаты высокой надежности (extended validation или EV). 

Сертификат высокой надежности обеспечивает более высокий уровень надежности и гарантий безопасности чем стандартные сертификаты, доказывая тем самым, что сайт не является одним из мошеннических или поддельных сайтов. 

### Известные проблемы, связанные с фильтрацией HTTPS

Недавнее [исследование](https://cdn.adguard.com/public/Adguard/Blog/https/interception-ndss17.pdf) показало, что от 5 до 10% HTTPS соединений осуществляется приложениями, осуществляющими фильтрацию HTTPS. В основном, это делают разнообразные антивирусы. Плохая новость в том, что 24 из 26 протестированных антивирусов тем или иным способом понижали защищенность соединения, а две трети - создавали “уязвимые” к взлому HTTPS соединения.

Вывод, сделанный исследователями - сообщество, занимающееся интернет-безопасностью, должно обратить пристальное внимание на работу программ, фильтрующих защищенные соединения. Разработчики же таких программ должны максимально серьезно озаботиться качеством реализации фильтрации.

Хочу заметить, что AdGuard не был протестирован исследователями. По нашим прикидкам, судя по набору проверок, на момент тестирования мы бы получили максимальную оценку A\*. Тем не менее, эта оценка не является идеалом. Есть целый набор проблем, которые были обозначены исследователями, но которые не учитывались в итоговой оценке.

Мы в AdGuard совершенно согласны с выводами, сделанными исследователями. Более того, мы хотим быть открытыми с пользователями и рассказать о том, какие проблемы у нас сейчас есть, и какие шаги мы предпринимаем для улучшения качества и защищенности механизмов фильтрации. Список этих проблем отсортирован по приоритету.

Большая часть проблем, найденных в исследовании выше, связаны с механизмами валидации сертификатов. На этом мы хотим сконцентрироваться в первую очередь. Мы ведем работу над отдельной библиотекой валидации сертификатов, более того, мы хотим выложить ее код в открытый доступ. В [отдельной статье](https://kb.adguard.com/ru/general/https-filtering/https-filtering-known-issues) мы перечислили все известные недостатки фильтрации HTTPS в AdGuard и планируемые сроки их устранения.

#### Проблемы HTTPS фильтрации на Android 7+

[Начиная с Android 7](https://blog.adguard.com/ru/vykhod-android-7-nougat-i-chto-eto-oznachaiet-dlia-polzovatieliei-adguard/), разработчики должны явно указывать, что их приложения доверяют пользовательским сертификатам. Не все из них делают это — кто-то не хочет, кто-то просто не озабочивается. Что это значит для пользователей AdGuard? AdGuard устанавливает свой сертификат в пользовательское хранилище, чтобы иметь возможность фильтровать HTTPS трафик. Если приложение не доверяет этому сертификату, его HTTPS трафик останется неотфильтрованным. Что же делать?

Во-первых, необходимо уточнить, что все старые, и некоторые (на самом деле многие) новые приложения всё-таки доверяют пользователским сертификатам. В их отношении ничего не меняется. Это относится практически ко всем браузерам, может быть, за исключением некоторых экзотических, но они скорее являются исключениями по сравнению с большинством. 

Наконец, если у вас есть ROOT-доступ к вашему устройству, вы можете переместить сертификат AdGuard в системное хранилище. Тогда вам не придется волноваться о том, доверяет то или иное приложение пользовательским сертификатам — HTTPS трафик будет фильтроваться одинаково хорошо в любых приложениях. Обратите внимание, что перенос сертификата в системные влечет за собой дополнительные ограничения безопасности: HPKP и Certificate Transparency.

### Как самостоятельно проверить качество HTTPS?

Существует несколько сайтов, созданных специально для проверки качества HTTPS соединений. Эти сайты проверяют, подвержен ли браузер (или браузер+AdGuard в нашем случае) основным уязвимостям. Если вы собираетесь использовать программу, фильтрующую HTTPS (не обязательно AdGuard, это может быть какой-либо антивирус), мы советуем проверить качество соединения на этих сайтах.

* [https://www.ssllabs.com/ssltest/viewMyClient.html](https://www.ssllabs.com/ssltest/viewMyClient.html)
* [https://www.howsmyssl.com/](https://www.howsmyssl.com/)
* [https://badssl.com/](https://badssl.com/)
